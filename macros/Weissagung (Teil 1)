const sourceActor = canvas.tokens.controlled[0]?.actor || game.user.character;
if (!sourceActor) {
  ui.notifications.warn("Bitte zuerst deinen Token auswählen oder ein verknüpftes Charakter-Actor besitzen.");
  return;
}
const senderName = sourceActor.name;

const targets = Array.from(game.user.targets);
if (targets.length !== 1) {
  ui.notifications.warn("Bitte genau ein Ziel auswählen.");
  return;
}
const targetToken = targets[0];
const targetActor = targetToken.actor;

const targetUsers = game.users.players.filter(u => targetActor?.testUserPermission(u, "OWNER"));
if (targetUsers.length === 0) {
  ui.notifications.warn("Kein Spieler besitzt das gewählte Ziel.");
  return;
}

const whisperRecipients = targetUsers.map(u => u.id);

// UUID des Makros ( hier hab ich es als Platzhalter in Geschöpfe der Anderswelt hinterlegt)
const macroUUID = "Compendium.dsa5-otherworld.otherworldabilitymacros.Macro.vl72iZIaQG4fVXkx";

// Chat-Message mit Foundry-Makro-Link
const messageContent = `
<div style="text-align:center; font-style: italic; margin-bottom: 10px;">
  ${senderName} möchte dir eine @UUID[${macroUUID}]{Weissagung} machen.
</div>
`;

await ChatMessage.create({
  content: messageContent,
  whisper: whisperRecipients
});
