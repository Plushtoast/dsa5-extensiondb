// --- Sonderfertigkeit: Kräutermischung ---
const actorTarget = canvas.tokens.controlled[0]?.actor;
if (!actorTarget) { 
    ui.notifications.warn("Dieses Makro benötigt einen Akteur."); 
    return; 
}

// Prüfen, ob die allgemeine Sonderfertigkeit "Meisterliche Kräutermischung" vorhanden ist
const hasMastery = actorTarget.items.some(i =>
    i.system.category?.value === "general" &&
    i.name === "Meisterliche Kräutermischung"
);

// Prüfen, ob die Sonderfertigkeit "Weg des Apothekers" vorhanden ist
let sfName = "Weg des Apothekers";
let hasApothecary = actorTarget.items.find(i => i.name === sfName);

// Item-Makro-Text abhängig von den Sonderfertigkeiten
const herbMacroText = `let currentTempHeal = actor.system.status.regeneration.LePTemp;
const mapping = [1,2,3,4,5,6];
const wuerfelziel = mapping[qs - 1] ?? 0;
const roll = await new Roll("${hasApothecary ? "2d6kl1" : "1d6"}").roll({async: true});
if (roll.total <= wuerfelziel) {
    await actor.update({ "system.status.regeneration.LePTemp": currentTempHeal + ${hasMastery ? 2 : 1} });
}`;

// --- Prozess Kräutermischung ---
async function processHerbMixing() {
    const lang = game.i18n.lang === "de" ? "de" : "en";
    const dict = { de: { skillName: "Pflanzenkunde" } }[lang];
    const skill = actorTarget.items.find(x => x.type === "skill" && x.name === dict.skillName);

    if (!skill) {
        ui.notifications.error(`${actorTarget.name} hat das Talent Pflanzenkunde nicht.`);
        return;
    }

    const setupData = await actorTarget.setupSkill(skill, { modifier: 2, subtitle: " (Kräutermischung)" }, actorTarget.sheet.getTokenId());
    setupData.testData.opposable = false;
    const res = await actorTarget.basicTest(setupData);
    const availableQs = Number(res.result.qualityStep);

    if (availableQs <= 0) {
        ui.notifications.info(`${actorTarget.name} hat die Probe auf Pflanzenkunde nicht bestanden. Keine Kräutermischung erhalten.`);
        return;
    }

    const itemName = "Kräutermischung";
    const qsText = `1: Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.
Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.
Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.
Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.
Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.
Vorhandene Wunden wurden versorgt. Die nächste Regenerationsphase ist ggf. erhöht.`;

    // Neues Item vorbereiten
    const newItem = {
        name: itemName,
        type: "consumable",
        img: "systems/dsa5/icons/categories/plant.webp",
        system: {
            equipmentType: { value: "healing" },
            quantity: 1,
            weight: 0.1,
            price: { value: 5, currency: "silver" },
            QLList: qsText,
            QL: availableQs,
            description: {
                value: "Es muss nicht immer Tarnele oder Wirselkraut sein. Mit der richtigen Mischung kann ein Heiler auch aus anderen, einfachen Heilkräutern eine potente Kräutermischung herstellen."
            }
        },
        effects: [
            {
                name: "Kräutermischungseffekt",
                type: "",
                img: "icons/svg/aura.svg",
                changes: [],
                duration: { startTime: null, seconds: null, rounds: null },
                flags: {
                    dsa5: {
                        advancedFunction: 2,  // Dropdown-Menü
                        args3: herbMacroText   // Mischungs-Makro
                    }
                },
                disabled: false,
                transfer: false
            }
        ]
    };

    // Wenn Weg des Apothekers vorhanden → 2 Items erstellen
    const itemCount = hasApothecary ? 2 : 1;
    let created = [];
    for (let i = 0; i < itemCount; i++) {
        created.push(newItem);
    }

    await actorTarget.createEmbeddedDocuments("Item", created);
    ui.notifications.info(`${actorTarget.name} hat erfolgreich ${itemCount} Kräutermischung${itemCount > 1 ? "en" : ""} hergestellt (QS=${availableQs}).`);
}

// --- Dialog für die Sonderfertigkeit ---
new Dialog({
    title: "Sonderfertigkeit: Kräutermischung",
    content: `<p>Die Heldin ist dazu in der Lage, eine Kräutermischung anzufertigen, die die Regeneration verbessert. Diese Mischung besteht nicht aus den üblichen Heilkräutern, die LeP regenerieren können, sondern aus einfachen, je nach Region unterschiedlichen Heilkräutern, die insgesamt pro Anwendung der Sonderfertigkeit 5 Silbertaler kosten. Alternativ kann die Heldin die Materialien auch selbst suchen. Sie benötigt dafür 4 Stunden, sofern es in der näheren Umgebung auch die nötigen Materialien gibt (was z. B. in Sand- oder Eiswüsten nicht der Fall ist). </p>`,
    buttons: {
        mischen: { label: "Mischen", callback: () => processHerbMixing() },
        abbrechen: { label: "Abbrechen" }
    },
    default: "abbrechen"
}).render(true);
