if (!actor) {
  ui.notifications.error("Kein Actor gefunden – bitte Makro ausführen, während ein Actor ausgewählt ist.");
  return;
}

(async () => {
  let current = getProperty(actor.system, "status.fatePoints.value") ?? 0;
  let max = getProperty(actor.system, "status.fatePoints.max") ?? 0;

  if (current >= max) {
    ui.notifications.info(`${actor.name} hat bereits das Maximum an Schicksalspunkten erreicht. Die Probe findet nicht statt.`);
    return;
  }

  const skill = actor.items.find(i => i.type === "skill" && i.name === "Götter & Kulte");
  if (!skill) {
    ui.notifications.error(`${actor.name} hat keine Fertigkeit "Götter & Kulte".`);
    return;
  }

  const setupData = await actor.setupSkill(skill, {}, actor.sheet.getTokenId());
  setupData.testData.opposable = false;

  const res = await actor.basicTest(setupData);
  const ql = res.result.qualityStep || 0;

  if (res.result.successLevel > 0) {
    await actor.update({ "system.status.fatePoints.value": current + 1 });
    current += 1;

    const durationSec = Math.max(0, 43200 - 3600 * ql);
    const durationHours = (durationSec / 3600).toFixed(2);

    if (durationSec > 0) {
      const effectData = {
        name: "Vision des Schicksals",
        icon: "icons/svg/aura.svg",
        origin: actor.uuid,
        duration: { seconds: durationSec },
        changes: [
          // Mode 0 für globale Fertigkeitsänderung
          {
            key: "system.skillModifiers.global",
            value: -1,
            mode: 0,
            priority: 20,
          },
          // Mode 2 für Nahkampf, Parade, Ausweichen und Fernkampf
          {
            key: "system.meleeStats.attack",
            value: -1,
            mode: 2,
            priority: 20,
          },
          {
            key: "system.meleeStats.parry",
            value: -1,
            mode: 2,
            priority: 20,
          },
          {
            key: "system.status.dodge.gearmodifier",
            value: -1,
            mode: 2,
            priority: 20,
          },
          {
            key: "system.rangeStats.attack",
            value: -1,
            mode: 2,
            priority: 20,
          }
        ],
        flags: {
          dsa5: {
            description: "Erschwernis -1 auf Fertigkeiten, Nahkampf, Parade, Ausweichen und Fernkampf.",
          },
        },
      };
      await actor.createEmbeddedDocuments("ActiveEffect", [effectData]);
    }

    ui.notifications.info(`${actor.name} erhält 1 Schicksalspunkt (${current}/${max}) und den Effekt "Vision des Schicksals" für ${durationHours} Stunden.`);
  } else {
    ui.notifications.warn(`${actor.name} hat die Probe auf "Götter & Kulte" nicht bestanden.`);
  }
})();
